# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/authoring-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: porter-iot-remote-kube
version: 0.1.0
description: "An example that uses a cert to deploy to Azure Stack AKS on the internet but secured with a cert."
invocationImage: squillace.azurecr.io/squillace/porter-iot-remote-kube:latest
tag: squillace.azurecr.io/squillace/porter-iot-remote-kube:latest

# Uncomment out the line below to use a template Dockerfile for your invocation image
#dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - kubernetes

customActions:
  com.azure.iot.deployment.status:
    description: "Getting the status of the Azure IoT deployments."
    stateless: false
    modifies: false

install:
  - exec:
      description: "Install Hello World"
      command: bash
      arguments:
        - -c
        - echo Hello World

upgrade:
  - exec:
      description: "World 2.0"
      command: bash
      arguments:
        - -c
        - echo World 2.0

uninstall:
  - exec:
      description: "Uninstall Hello World"
      command: bash
      arguments:
        - -c
        - echo Goodbye World

com.azure.iot.deployment.status:
  - exec: 
      description: "Azure CLI login"
      command: "az"
      arguments: 
        - "login" 
        - "--service-principal"
        - "--username" 
        - "{{ bundle.credentials.AZURE_CLIENT_ID}}"
        - "--password" 
        - "{{ bundle.credentials.AZURE_SP_PASSWORD}}"
        - "--tenant" 
        - "{{ bundle.credentials.TENANT_DNS}}"

  - exec: 
      description: "Azure IoT Edge deployment: Querying the deployments."
      command: "az"
      arguments: 
        - "iot"
        - "edge"
        - "deployment"
        - "list"
        - "--resource-group"
        - "{{ bundle.parameters.AZURE_RESOURCE_GROUP }}"
        - "--hub-name"
        - "{{ bundle.parameters.HUB_NAME }}"
        - "--query"
        - "[].{ID:id,Priority:priority,Applied:systemMetrics.results.appliedCount,Targeted:systemMetrics.results.targetedCount,Failed:systemMetrics.results.reportedFailedCount,Succeeded:systemMetrics.results.reportedSuccessfulCount,Target:targetCondition,Created:createdTimeUtc,Updated:lastUpdatedTimeUtc}"
        - "--output"
        - "table"
# See https://porter.sh/authoring-bundles/#dependencies
#dependencies:
#  mysql:
#    tag: deislabs/porter-mysql:latest
#    parameters:
#      database-name: wordpress

# See https://porter.sh/wiring/#credentials
credentials:
  - name: kubeconfig
    path: /root/.kube/config
  - name: AZURE_CLIENT_ID
    env: AZURE_CLIENT_ID
  - name: TENANT_DNS
    env: TENANT_DNS
  - name: AZURE_SP_PASSWORD
    env: AZURE_SP_PASSWORD

parameters:
  - name: AZURE_RESOURCE_GROUP
    type: string
    default: IoTEdgeResources
    destination:
      env: AZURE_RESOURCE_GROUP
  - name: CONDITION
    type: string
    default: target
    destination:
      env: CONDITION
  - name: DEPLOYMENT_ID
    type: string
    default: sql
    destination:
      env: DEPLOYMENT_ID
  - name: HUB_NAME
    type: string
    default: cnab-hub
    destination:
      env: HUB_NAME